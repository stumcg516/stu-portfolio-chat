name: Reindex Knowledge Base

on:
  # Manual trigger in the Actions tab
  workflow_dispatch:

  # Auto-trigger when knowledge files change
  push:
    branches: [ main ]
    paths:
      - 'knowledge/**'
      - 'app/knowledge/**'

jobs:
  reindex:
    runs-on: ubuntu-latest
    steps:
      - name: Call Reindex Endpoint
        run: |
          URL="${{ secrets.REINDEX_URL }}"
          if [ -z "$URL" ]; then
            echo "❌ Missing REINDEX_URL secret"; exit 1
          fi
          echo "Calling: $URL"
          CODE=$(curl -sS -o out.json -w "%{http_code}" "$URL")
          echo "HTTP $CODE"
          cat out.json || true
          if [ "$CODE" = "200" ]; then
            echo "✅ Reindex succeeded"
            exit 0
          else
            echo "❌ Reindex failed"
            exit 1
          fi
