name: Reindex Knowledge Base

on:
  push:
    branches: [ main ]

jobs:
  wait-and-reindex:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      REINDEX_BASE: ${{ secrets.REINDEX_BASE }}
      REINDEX_TOKEN: ${{ secrets.REINDEX_TOKEN }}

    steps:
      - name: Validate required secrets
        run: |
          test -n "${VERCEL_TOKEN}" || (echo "Missing VERCEL_TOKEN" && exit 1)
          test -n "${VERCEL_PROJECT_ID}" || (echo "Missing VERCEL_PROJECT_ID" && exit 1)
          test -n "${REINDEX_BASE}" || (echo "Missing REINDEX_BASE" && exit 1)
          test -n "${REINDEX_TOKEN}" || (echo "Missing REINDEX_TOKEN" && exit 1)

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Wait for latest Vercel deployment to be READY
        run: |
          set -euo pipefail
          echo "Waiting for latest production deployment to be READY…"
          for i in {1..30}; do
            url="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&limit=1&state=READY&target=production"
            res=$(curl -sS -H "Authorization: Bearer ${VERCEL_TOKEN}" "$url")
            count=$(echo "$res" | jq '.deployments | length')
            if [ "$count" -ge 1 ]; then
              echo "Found READY deployment."
              break
            fi
            echo "Not ready yet… attempt $i"
            sleep 5
          done

      - name: Call reindex endpoint (token url-encoded)
        run: |
          set -euo pipefail
          echo "Calling: ${REINDEX_BASE}?token=***"
          resp=$(curl -sS -G "${REINDEX_BASE}" --data-urlencode "token=${REINDEX_TOKEN}")
          echo "$resp" | tee /tmp/reindex.json
          # require { ok: true } from your route
          echo "$resp" | jq -e '.ok == true' >/dev/null

      - name: Summary
        if: always()
        run: |
          echo "---- reindex response ----"
          cat /tmp/reindex.json || true

